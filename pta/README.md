# PTA (Packet Traffic Arbitration) python scripts

PTA is used to manage radio coexistence of Wi-Fi with other standards

Common use cases are:
* Wi-Fi + Bluetooth
* Wi-Fi + Zigbee

(Watch https://www.youtube.com/watch?v=BiEe_EbhpGg to discover the benefits of PTA and
visit https://www.silabs.com/products/wireless/learning-center/wi-fi-coexistence for more details)

## Usage

To manage PTA, sending configuration data is required to
* Provide the PTA settings to the WFX firmware
* Control the PTA priority
* Turn PTA on/off

## Source repository
https://github.com/SiliconLabs/wfx-common-tools

## Python version
The scripts have been written for and tested for Python3 

## Installation
These scripts are used to format PTA bytes according to the user's preferences and send them to the WFX firmware.

They can be used either directly on the target or on a remote tester, via the **WFX connection layer**

### Prerequisites
First install the  **WFX connection layer**
The connection layer is the same as the one used for WFX RF testing, allowing connection in the following modes:
* Local
* SSH
* UART
* Telnet

The connection layer is available in 
https://github.com/SiliconLabs/wfx-common-tools/tree/master/connection
(a subfolder of `wfx-common-tools`, so from the PTA scripts perspective they are under `../connection`)

Refer to 
https://github.com/SiliconLabs/wfx-common-tools/blob/master/connection/README.md
 for details on the connection layer and its installation.

----------------

### PTA scripts installation
Once you have installed the **WFX connection layer** you will also have installed the Python scripts for PTA, since
these are in the same repository, in the `pta` folder.
```
cd siliconlabs/wfx-common-tools/pta
```

----------------

### PTA help
Help can be obtained using the `pta_help()` function, and will also be displayed in case a function parameter
 is missing or invalid.
```
python3
>>> from wfx_pta import *
>>> dut = WfxPtaTarget('local')
>>> dut.pta_help()
```
#### PTA help content
```
usage: wfx_pta.py [-h] [--version]
                  [--config {3w_ble,3w_not_combined_zigbee,3w_combined_zigbee}]
                  [--pta_mode {3w,1w_coex_master,2w,4w}]
                  [--request_signal_active_level {low,high}]
                  [--priority_signal_active_level {low,high}]
                  [--freq_signal_active_level {low,high}]
                  [--grant_signal_active_level {low,high}]
                  [--coex_type {generic,ble}]
                  [--default_grant_state {no_grant,grant}]
                  [--simultaneous_rx_accesses {false,true}]
                  [--priority_sampling_time PRIORITY_SAMPLING_TIME]
                  [--tx_rx_sampling_time TX_RX_SAMPLING_TIME]
                  [--freq_sampling_time FREQ_SAMPLING_TIME]
                  [--grant_valid_time GRANT_VALID_TIME]
                  [--fem_control_time FEM_CONTROL_TIME]
                  [--first_slot_time FIRST_SLOT_TIME]
                  [--periodic_tx_rx_sampling_time PERIODIC_TX_RX_SAMPLING_TIME]
                  [--coex_quota COEX_QUOTA] [--wlan_quota WLAN_QUOTA]
                  [--priority_mode {coex_maximized,coex_high,balanced,wlan_high,wlan_maximized}]
                  [--state {off,on}]
                  {settings,priority,state}

        Prepare and send PTA parameters depending on the selected pta_cmd


positional arguments:
  {settings,priority,state}
                        pta_cmd <settings/priority/state>

optional arguments:
  -h, --help            show this help message and exit
  --version             show program's version number and exit

settings options:
  --config {3w_ble,3w_not_combined_zigbee,3w_combined_zigbee}
                        Preset configurations for common use cases (presets
                        required non-default 'settings' options, these can
                        then be overwritten using options listed below)
  --pta_mode {3w,1w_coex_master,2w,4w}
                        PTA mode selection (default 1w_wlan_master)
  --request_signal_active_level {low,high}
                        Active level on REQUEST signal, provided by Coex to
                        request the RF (default high)
  --priority_signal_active_level {low,high}
                        Active level on PRIORITY signal, provided by Coex to
                        set the priority of the request (default high)
  --freq_signal_active_level {low,high}
                        Active level on FREQ signal, provided by Coex in
                        4-wire mode when Coex and Wlan share the same band
                        (default high)
  --grant_signal_active_level {low,high}
                        Active level on grant signal, generated by PTA to
                        grant the RF to Coex (default low)
  --coex_type {generic,ble}
                        Coex type (default generic)
  --default_grant_state {no_grant,grant}
                        state of the grant signal before arbitration at
                        grant_valid_time (default grant)
  --simultaneous_rx_accesses {false,true}
                        (uint8), Boolean to allow both Coex and Wlan to
                        receive concurrently, also named combined mode
                        (default false)
  --priority_sampling_time PRIORITY_SAMPLING_TIME
                        (uint8), Time in microseconds from the Coex request to
                        the sampling of the priority on PRIORITY signal (1 to
                        31), (default 10)
  --tx_rx_sampling_time TX_RX_SAMPLING_TIME
                        (uint8), Time in microseconds from the Coex request to
                        the sampling of the directionality on PRIORITY signal
                        (priority_sampling_time to 63) (default 50)
  --freq_sampling_time FREQ_SAMPLING_TIME
                        (uint8), Time in microseconds from the Coex request to
                        the sampling of the freq-match information on FREQ
                        signal (1 to 127) (default 40)
  --grant_valid_time GRANT_VALID_TIME
                        (uint8), Time in microseconds from Coex request to the
                        grant signal assertion (max(tx_rx_sampling_time,
                        freq_sampling_time), to 0xFF), (default 72)
  --fem_control_time FEM_CONTROL_TIME
                        (uint8), Time in microseconds from Coex request to the
                        control of FEM (grant_valid_time to 0xFF), (default
                        140)
  --first_slot_time FIRST_SLOT_TIME
                        (uint8), Time in microseconds from the Coex request to
                        the beginning of reception or transmission
                        (grant_valid_time to 0xFF), (default 150)
  --periodic_tx_rx_sampling_time PERIODIC_TX_RX_SAMPLING_TIME
                        (uint16), Period in microseconds from first_slot_time
                        of following samplings of the directionality on
                        PRIORITY signal (1 to 1023), (default 1)
  --coex_quota COEX_QUOTA
                        (uint16), Duration in microseconds for which RF is
                        granted to Coex before it is moved to Wlan (default
                        7500)
  --wlan_quota WLAN_QUOTA
                        (uint16), Duration in microseconds for which RF is
                        granted to Wlan before it is moved to Coex (default
                        7500)

priority options:
  --priority_mode {coex_maximized,coex_high,balanced,wlan_high,wlan_maximized}
                        coex_maximized = 0x0562 : Maximizes priority to COEX,
                        WLAN connection is not ensured. coex_high = 0x0462 :
                        High priority to COEX, targets low-latency to COEX.
                        balanced = 0x1461 : Balanced PTA arbitration, WLAN
                        acknowledge receptions are protected. wlan_high =
                        0x1851 : High priority to WLAN, protects WLAN
                        transmissions. wlan_maximized = 0x1A51 : Maximizes
                        priority to WLAN

state options:
  --state {off,on}      PTA state on/off

        Examples:

        Python3 interpreter:
        python3
         >>> from wfx_pta import *
        selecting the connection mode to match your DUT:
         >>> dut = WfxPtaTarget('Pi203', host='pi203', user='pi', port=22, password='default_password')
         >>> dut = WfxPtaTarget('Serial', port='COM8')
         >>> dut = WfxPtaTarget('Local')
         selecting settings, priority and activating PTA:
         >>> dut.settings('--config 3w_ble --first_slot_time 123')
         >>> dut.priority('--priority_mode balanced')
         >>> dut.state('--state on')
         activating PTA traces (tracks PTA data values):
         >>> dut.trace = True
         activating communication link traces (tracks bytes write/read):
         >>> dut.link.trace = True

        Command line using 'wfx_pta.py': directly sending PTA bytes to a 'Local' DUT:
         (bytes silently sent to DUT)
           python wfx_pta.py settings --config 3w_ble
           python wfx_pta.py priority --priority_mode balanced
           python wfx_pta.py state --state on
         (verbose mode)
           python wfx_pta.py settings --config 3w_ble verbose
            Local: configuring a Direct connection
            ['settings', '--config', '3w_ble']
            configuring for 3w_ble
            pta_mode                        1w_wlan_master =>       3w
            coex_type                        generic =>      ble
            tx_rx_sampling_time                   50 =>        0
            freq_sampling_time                    40 =>        0
            first_slot_time                      150 =>        0
            periodic_tx_rx_sampling_time           1 =>        0
            pta_mode                          3w         \x03
            request_signal_active_level       high       \x01
            priority_signal_active_level      high       \x01
            freq_signal_active_level          high       \x01
            grant_signal_active_level         low        \x00
            coex_type                         ble        \x01
            default_grant_state               grant      \x01
            simultaneous_rx_accesses          false      \x00
            priority_sampling_time            10         \x0a
            tx_rx_sampling_time               0          \x00
            freq_sampling_time                0          \x00
            grant_valid_time                  72         \x48
            fem_control_time                  140        \x8c
            first_slot_time                   0          \x00
            periodic_tx_rx_sampling_time      0          \x00\x00
            coex_quota                        7500       \x4c\x1d
            wlan_quota                        7500       \x4c\x1d
            Local    D>>|  wfx_exec wfx_hif_send_msg "\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x00\x00\x48\x8c\x00\x00\x00\x4c\x1d\x4c\x1d"
            Local    D<<|  0

        Command line using 'wfx_pta_data.py': retrieving the PTA bytes (no byte sent to HW):
          python wfx_pta_data.py settings --config 3w_ble
            \x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x00\x00\x48\x8c\x00\x00\x00\x4c\x1d\x4c\x1d
          python wfx_pta_data.py settings --config 3w_ble --grant_valid_time 40 --priority_sampling_time 8
            \x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x08\x00\x00\x28\x8c\x00\x00\x00\x4c\x1d\x4c\x1d
          python wfx_pta_data.py priority --priority_mode balanced
            \x08\x00\x2c\x00\x61\x14\x00\x00
          python wfx_pta_data.py state --state on
            \x08\x00\x2d\x00\x01\x00\x00\x00
          python wfx_pta_data.py state --state off
            \x08\x00\x2d\x00\x00\x00\x00\x00

```
## PTA API
### settings(options)

PTA settings are filled based on the `options` string as a structure with the following parameters

| parameter                   | Possible values                      | default       |
|-----------------------------|--------------------------------------|---------------|
| pta_mode                    |1w_wlan_master,1w_coex_master,2w,3w,4w| 3w            |
| request_signal_active_level |low,high                              | high          |
| priority_signal_active_level|low,high                              | high          |
| freq_signal_active_level    |low,high                              | high          |
| grant_signal_active_level   |low,high                              | low           |
| coex_type                   |generic,ble                           | ble           |
| default_grant_state         |no_grant,grant                        | grant         |
| simultaneous_rx_accesses    |false,true                            | false         |
| priority_sampling_time      |1 to 31                               |  10           |
| tx_rx_sampling_time         |1 to 50                               |  50           |
| freq_sampling_time          |1 to 127                              |  40           |
| grant_valid_time            |int                                   |  72           |
| fem_control_time            |int                                   | 140           |
| first_slot_time             |int                                   | 150           |
| periodic_tx_rx_sampling_time|1 to 1023                             |   1           |
| coex_quota                  |int                                   |7500           |
| wlan_quota                  |int                                   |7500           |

* Each parameter can be set using the `--<parameter>=<value>` syntax
* No specific order for parameters provided in the `options` string
* All parameters are optional

#### PTA setting pre-filled configurations

Typical pre-filled configurations (matching common use cases) can be selected using an additional `config` parameter.
There are 4 such configurations:

| '--config=<pre_filled_config>'| pre-filled options         |
|-------------------------------|----------------------------|
| 3w_ble                        |pta_mode=3w <br>coex_type=ble     <br>simultaneous_rx_accesses=true  <br>priority_sampling_time=10
| 3w_not_combined_zigbee        |pta_mode=3w <br>coex_type=generic <br>simultaneous_rx_accesses=false <br>priority_sampling_time=10 <br>grant_valid_time=20 <br>fem_control_time=20
| 3w_combined_zigbee            |pta_mode=3w <br>coex_type=generic <br>simultaneous_rx_accesses=true  <br>priority_sampling_time=10 <br>tx_rx_sampling_time=30 <br>grant_valid_time=40 <br>fem_control_time=40 <br>first_slot_time=40|

#### PTA settings defaults vs pre-filled configurations vs user options
**PTA settings** are applied in the following order:

* All defaults
* Pre-filled configuration options values
* User options

NB: Using the PTA data filling tracing (described below) can be a good way to become familiar with this process

## Use case 1: from a Python3 interpreter 
```
python3
>>> from wfx_pta import *
```
### Connection
Select one of (with your own parameters for the SSH or UART cases)
```
>>> dut = WfxPtaTarget('Pi203', host='pi203', user='pi', port=22, password='default_password')
>>> dut = WfxPtaTarget('Serial', port='COM8')
>>> dut = WfxPtaTarget('Local')
```

### PTA settings 
**All defaults + pta_mode & tx_rx_sampling_time**
```
>>> dut.settings('--pta_mode 3w --tx_rx_sampling_time 30')
```
**Pre-filled configuration 'as is'**
```
>>> dut.settings('--config 3w_ble')
```
**Pre-filled configuration + user-selected values**
```
>>> dut.settings('--config 3w_ble --first_slot_time 123')
```
### PTA priority
```
>>> dut.priority('--priority_mode balanced')
```
### PTA state
```
>>> dut.state('--state off')
```

### Tracing
#### Tracing PTA data filling
Adding `mode='verbose'` to a PTA function call will enable tracing of the PTA data filling process

**without traces**
```
>>> dut.settings('--config 3w_ble')
'HI_STATUS_SUCCESS'
```
**with traces**
```
>>> dut.settings('--config 3w_ble --fem_control_time 135', mode='verbose')
['settings', '--config', '3w_ble', '--fem_control_time', '135']
configuring for 3w_ble
coex_type                              0 =>        1 (x1)
pta_mode                               0 =>        3 (x3)
priority_sampling_time                 9 =>       10 (xa)
fem_control_time                     140 ->      135 (x135)
pta_mode                          3          \x03
request_signal_active_level       1          \x01
priority_signal_active_level      1          \x01
freq_signal_active_level          1          \x01
grant_signal_active_level         0          \x00
coex_type                         1          \x01
default_grant_state               1          \x01
simultaneous_rx_accesses          false      \x00
priority_sampling_time            10         \x0a
tx_rx_sampling_time               50         \x32
freq_sampling_time                70         \x46
grant_valid_time                  72         \x48
fem_control_time                  135        \x87
first_slot_time                   150        \x96
periodic_tx_rx_sampling_time      1          \x01\x00
coex_quota                        0          \x00\x00
wlan_quota                        0          \x00\x00
'HI_STATUS_SUCCESS'
>>>
```
NB: Above we can see
 * Indicated with `=>`: the changes done on the defaults when applying '3w_ble'
 * Indicated with `->`: the changes done on the current settings when applying '--fem_control_time 135'
 * When there is a change from the default: the default values on the left side, the final value on the right
 
#### Tracing PTA data transmission
It is also possible to track the connection layer communication with the DUT, using
```
>>> dut.link.trace = True
```
**without connection traces**
```
>>> dut.settings('--config 3w_ble')
'HI_STATUS_SUCCESS'
```
**with connection traces**
```
>>> dut.settings('--config 3w_ble')
pi       D>>|  wfx_exec wfx_hif_send_msg "\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x46\x48\x8c\x96\x01\x00\x00\x00\x00\x00"
<<D       pi|  0
'HI_STATUS_SUCCESS'
```
## Use case 2: command line to retrieve PTA formatted data
### settings
`python wfx_pta.py settings --config 3w_ble`
### priority
`python wfx_pta.py priority --priority_mode balanced`
### state
`python wfx_pta.py state --state on`
### tracing
add 'verbose' to the command to trace PTA data filling
`python wfx_pta.py settings --config 3w_ble verbose`

## Use case 3: command line to directly send PTA data
### settings
`python wfx_pta_data.py settings --config 3w_ble --grant_valid_time 40 --priority_sampling_time 8`
### priority
`python wfx_pta_data.py priority --priority_mode balanced`
### state
`python wfx_pta_data.py state --state on`

# Self test
A specific `selftest` function has been added to allow testing proper installation of the tools.
`selftest` calls the 3 PTA functions will valid example values to check that PAT data formatting and transmission
 is working as expected. To achieve this, internal tracing features are used.

## Running the self test
```
python3 wfx_pta_data.py
```
## Expected result of dut.selftest():
```
['settings', '--config', '3w_ble', '--request_signal_active_level', 'low', '--first_slot_time', '123']
configuring for 3w_ble
tx_rx_sampling_time                  50 =>        0
freq_sampling_time                   40 =>        0
first_slot_time                     150 =>        0
periodic_tx_rx_sampling_time          1 =>        0
request_signal_active_level        high ->      low
first_slot_time                       0 ->      123
pta_mode                       3w         \x03
request_signal_active_level    low        \x00
priority_signal_active_level   high       \x01
freq_signal_active_level       high       \x01
grant_signal_active_level      low        \x00
coex_type                      ble        \x01
default_grant_state            grant      \x01
simultaneous_rx_accesses       false      \x00
priority_sampling_time         10         \x0a
tx_rx_sampling_time            0          \x00
freq_sampling_time             0          \x00
grant_valid_time               72         \x48
fem_control_time               140        \x8c
first_slot_time                123        \x7b
periodic_tx_rx_sampling_time   0          \x00\x00
coex_quota                     7500       \x4c\x1d
wlan_quota                     7500       \x4c\x1d
\x18\x00\x2b\x00\x03\x00\x01\x01\x00\x01\x01\x00\x0a\x00\x00\x48\x8c\x7b\x00\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x01\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x02\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x04\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x00\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x00\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x00\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x01\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x00\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x00\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x01\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x03\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x04\x28\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x05\x48\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x06\x8c\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x07\x96\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x08\x01\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x09\x00\x4c\x1d\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\xe8\x03\x4c\x1d
\x18\x00\x2b\x00\x03\x01\x01\x01\x00\x01\x01\x00\x0a\x32\x28\x48\x8c\x96\x01\x00\x4c\x1d\xd2\x04
\x08\x00\x2d\x00\x00\x00\x00\x00
\x08\x00\x2d\x00\x01\x00\x00\x00
\x08\x00\x2c\x00\x61\x14\x00\x00
```

